name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to Baota Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check changes
        id: check-changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æ–‡ä»¶å˜æ›´ï¼ˆæ’é™¤æ–‡æ¡£å’Œé…ç½®æ–‡ä»¶çš„ä¿®æ”¹ï¼‰
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -qvE '\.(md|txt|yml|yaml)$'; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ğŸ“¤ Upload code to server
        if: steps.check-changes.outputs.changed == 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT || 22 }}
          source: "."
          target: "/www/wwwroot/nestAdmin"
          strip_components: 0
          exclude: |
            node_modules
            dist
            logs
            .git
            .github
            *.log
            .env
            .env.local
            .env.*.local
            .pnpm-store
            .vite
            .cache
            coverage
            *.tsbuildinfo

      - name: ğŸš€ Deploy to server
        if: steps.check-changes.outputs.changed == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT || 22 }}
          script: |
            set -e
            
            # é¢œè‰²è¾“å‡º
            RED='\033[0;31m'
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            NC='\033[0m'
            
            echo -e "${GREEN}========================================${NC}"
            echo -e "${GREEN}ğŸš€ å¼€å§‹éƒ¨ç½² NestAdmin åˆ°ç”Ÿäº§ç¯å¢ƒ${NC}"
            echo -e "${GREEN}========================================${NC}"
            
            # é¡¹ç›®è·¯å¾„ï¼ˆæ ¹æ®å®å¡”é¢æ¿çš„å®é™…è·¯å¾„ï¼‰
            PROJECT_ROOT="/www/wwwroot/nestAdmin"
            DEPLOY_SCRIPT="${PROJECT_ROOT}/scripts/deploy.sh"
            
            # æ£€æŸ¥é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$PROJECT_ROOT" ]; then
              echo -e "${YELLOW}é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºç›®å½•...${NC}"
              mkdir -p "$PROJECT_ROOT"
            fi
            
            # æ£€æŸ¥éƒ¨ç½²è„šæœ¬æ˜¯å¦å­˜åœ¨
            if [ ! -f "$DEPLOY_SCRIPT" ]; then
              echo -e "${RED}âŒ é”™è¯¯: éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨: $DEPLOY_SCRIPT${NC}"
              exit 1
            fi
            
            # ç»™éƒ¨ç½²è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
            chmod +x "$DEPLOY_SCRIPT"
            
            # è®¾ç½®éƒ¨ç½²æ¨¡å¼ï¼ˆé»˜è®¤ä½¿ç”¨ pm2ï¼Œå¦‚æœä½¿ç”¨ Docker åˆ™è®¾ç½®ä¸º dockerï¼‰
            export DEPLOY_MODE="${DEPLOY_MODE:-pm2}"
            export SKIP_GIT_PULL="true"  # GitHub Actions å·²ç»æ‹‰å–äº†ä»£ç ï¼Œè·³è¿‡æœåŠ¡å™¨ç«¯çš„ git pull
            
            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            echo -e "${YELLOW}ğŸ”¨ æ‰§è¡Œéƒ¨ç½²è„šæœ¬ (æ¨¡å¼: $DEPLOY_MODE)...${NC}"
            bash "$DEPLOY_SCRIPT" || {
              echo -e "${RED}âŒ éƒ¨ç½²è„šæœ¬æ‰§è¡Œå¤±è´¥${NC}"
              exit 1
            }
            
            echo -e "${GREEN}========================================${NC}"
            echo -e "${GREEN}âœ… éƒ¨ç½²å®Œæˆï¼${NC}"
            echo -e "${GREEN}========================================${NC}"

      - name: âœ… Deployment Success Notification
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
          echo "æäº¤è€…: ${{ github.event.head_commit.author.name }}"
          echo "æäº¤å“ˆå¸Œ: ${{ github.sha }}"

      - name: â­ï¸ Skip Deployment
        if: steps.check-changes.outputs.changed == 'false'
        run: |
          echo "â­ï¸ æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦éƒ¨ç½²çš„ä»£ç å˜æ›´ï¼Œè·³è¿‡éƒ¨ç½²"

