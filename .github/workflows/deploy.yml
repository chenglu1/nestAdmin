name: Auto Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22.20.0'  # 满足前端要求的Node.js版本
      
      - name: Build Backend
        working-directory: ./backend
        run: npm install && npm run build
      
      - name: Build Frontend
        working-directory: ./frontend
        run: npm install && npm run build
      
      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.7  # 使用稳定版本
        with:
          # 直接使用host地址，确保在secrets中正确设置不带前缀的地址
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22  # 显式指定SSH端口
          timeout: 120s  # 增加超时时间
          debug: true  # 启用调试模式查看详细信息
          fingerprint: ''  # 不验证主机指纹以避免连接问题
          script_stop: true
          script: |
            # 设置详细输出模式，记录每个命令执行
            set -x
            # 出错时继续执行，但记录错误
            set +e
            
            # 输出初始环境信息
            echo "=== DEBUG INFO START ==="
            echo "🔍 开始部署流程，当前用户: $(whoami)"
            echo "🔍 当前目录: $(pwd)"
            echo "🔍 系统信息: $(uname -a)"
            echo "🔍 用户ID: $(id)"
            echo "🔍 环境变量:"
            printenv | grep -E "GITHUB|SERVER|PATH"
            echo "=== DEBUG INFO END ==="
            
            # 检查目录权限和存在性
            echo "📁 系统目录检查..."
            ls -la /home/ || echo "❌ 无法访问 /home/ 目录"
            
            # 确保目标目录存在 - 根据DEPLOYMENT.md文档，项目路径应使用/home/nestadmin
            echo "📁 检查并创建目标目录..."
            if [ -d "/home" ]; then
              echo "✅ /home 目录存在"
              # 检查用户权限
              if [ -w "/home" ]; then
                echo "✅ 有写入 /home 目录的权限"
                mkdir -p /home/nestadmin || {
                  echo "❌ 无法创建 /home/nestadmin 目录，错误码: $?"
                  # 检查是否因为权限问题
                  sudo mkdir -p /home/nestadmin 2>/dev/null || {
                    echo "❌ sudo 创建目录也失败，可能需要检查用户权限"
                  }
                  # 即使失败也继续执行，收集更多信息
                }
                
                # 检查创建的目录
                if [ -d "/home/nestadmin" ]; then
                  echo "✅ /home/nestadmin 目录创建成功"
                  ls -la /home/nestadmin
                else
                  echo "❌ /home/nestadmin 目录创建失败"
                  # 尝试使用临时目录作为备选方案
                  echo "🔄 尝试使用 /tmp/nestadmin 作为备选目录"
                  mkdir -p /tmp/nestadmin
                  if [ -d "/tmp/nestadmin" ]; then
                    echo "✅ 备选目录 /tmp/nestadmin 创建成功"
                    cd /tmp/nestadmin
                    echo "📁 切换到备选工作目录: $(pwd)"
                    # 后续操作将使用这个目录
                  else
                    echo "❌ 备选目录也创建失败，部署可能无法继续"
                  fi
                fi
              else
                echo "❌ 没有写入 /home 目录的权限"
                # 尝试使用临时目录
                echo "🔄 尝试使用 /tmp/nestadmin 作为备选目录"
                mkdir -p /tmp/nestadmin
                cd /tmp/nestadmin
                echo "📁 切换到备选工作目录: $(pwd)"
              fi
            else
              echo "❌ /home 目录不存在，检查服务器目录结构"
              # 列出根目录内容
              echo "📁 根目录内容:"
              ls -la /
            fi
            
            # 使用GitHub内置变量，避免依赖自定义环境变量
            REPO_URL="https://github.com/${{ github.repository }}.git"
            echo "📥 正在从 $REPO_URL 拉取代码..."
            
            # 检查git是否可用
            if command -v git &> /dev/null; then
              echo "✅ git 命令可用，版本: $(git --version)"
            else
              echo "❌ git 命令不可用，尝试安装..."
              apt-get update && apt-get install -y git
              if command -v git &> /dev/null; then
                echo "✅ git 安装成功"
              else
                echo "❌ git 安装失败，无法继续代码拉取"
              fi
            fi
            
            # 进入主目录或备选目录
            MAIN_DIR="/home/nestadmin"
            if [ -d "$MAIN_DIR" ]; then
              cd "$MAIN_DIR"
              echo "📁 当前工作目录: $(pwd)"
            else
              cd /tmp/nestadmin
              echo "📁 使用备选工作目录: $(pwd)"
              MAIN_DIR="/tmp/nestadmin"
            fi
            
            # 代码获取步骤 - 分解为多个小步骤
            echo "📦 开始代码获取步骤..."
            if [ -d ".git" ]; then
              echo "✅ 发现已有git仓库，更新代码..."
              git config --global --add safe.directory "$(pwd)"
              echo "🔍 查看当前git配置..."
              git config --list
              echo "🔍 查看当前分支..."
              git branch -a
              echo "🔍 远程仓库信息..."
              git remote -v || echo "❌ 远程仓库配置检查失败"
              echo "🔄 执行git fetch..."
              git fetch origin || {
                echo "❌ git fetch 失败，错误码: $?"
                echo "🔄 尝试重新设置远程仓库..."
                git remote remove origin || true
                git remote add origin "$REPO_URL"
                git fetch origin
              }
              echo "🔄 切换到main分支..."
              git checkout main || git checkout -b main origin/main
              echo "🔄 执行git pull..."
              git pull origin main
              echo "✅ 项目更新完成，检查状态..."
              git status
            else
              echo "🆕 初始化新项目..."
              echo "🔄 执行git init..."
              git init
              echo "🔄 添加远程仓库..."
              git remote add origin "$REPO_URL"
              echo "🔄 执行git fetch..."
              git fetch origin
              echo "🔄 创建并切换到main分支..."
              git checkout -b main origin/main
              echo "✅ 项目初始化完成，检查状态..."
              git status
            fi
            
            # 更新后端 - 增加详细调试
            echo "🔧 更新后端服务..."
            # 使用MAIN_DIR变量确保路径一致性
            BACKEND_DIR="$MAIN_DIR/backend"
            echo "📁 检查后端目录: $BACKEND_DIR"
            
            # 确保后端目录存在
            if [ -d "$BACKEND_DIR" ]; then
              echo "✅ 后端目录存在"
              cd "$BACKEND_DIR"
              echo "📁 切换到后端目录: $(pwd)"
              echo "📁 后端目录内容:"
              ls -la
              
              # 检查npm是否可用
              if command -v npm &> /dev/null; then
                echo "✅ npm 命令可用，版本: $(npm --version)"
                
                # 清理可能存在的node_modules，避免依赖冲突
                echo "🧹 清理旧依赖..."
                rm -rf node_modules 2>/dev/null || echo "⚠️  旧依赖清理失败，可能不存在"
                
                echo "📦 安装后端依赖..."
                # 使用更详细的日志级别
                npm install --production --legacy-peer-deps --verbose
                NPM_INSTALL_STATUS=$?
                if [ $NPM_INSTALL_STATUS -eq 0 ]; then
                  echo "✅ 后端依赖安装成功"
                else
                  echo "❌ 后端依赖安装失败，错误码: $NPM_INSTALL_STATUS"
                  echo "🔄 尝试使用yarn安装..."
                  if command -v yarn &> /dev/null; then
                    yarn install --production
                  else
                    echo "❌ yarn 不可用，跳过备选安装"
                  fi
                fi
                
                echo "🏗️  构建后端项目..."
                # 检查package.json是否存在
                if [ -f "package.json" ]; then
                  echo "✅ 发现package.json，查看构建脚本..."
                  grep -A 5 "scripts" package.json
                  npm run build
                  BUILD_STATUS=$?
                  if [ $BUILD_STATUS -eq 0 ]; then
                    echo "✅ 后端构建成功"
                    # 检查构建输出目录
                    if [ -d "dist" ]; then
                      echo "✅ 构建输出目录存在"
                      ls -la dist
                      # 检查主入口文件
                      if [ -f "dist/main.js" ]; then
                        echo "✅ 主入口文件 dist/main.js 存在"
                      else
                        echo "❌ 主入口文件不存在，检查构建配置"
                      fi
                    else
                      echo "❌ 构建输出目录不存在，构建可能失败"
                    fi
                  else
                    echo "❌ 后端构建失败，错误码: $BUILD_STATUS"
                  fi
                else
                  echo "❌ package.json 不存在，无法构建"
                fi
              else
                echo "❌ npm 命令不可用，尝试安装..."
                apt-get update && apt-get install -y npm
                if command -v npm &> /dev/null; then
                  echo "✅ npm 安装成功"
                else
                  echo "❌ npm 安装失败，后端部署无法继续"
                fi
              fi
            else
              echo "❌ 后端目录不存在: $BACKEND_DIR"
              echo "📁 检查项目根目录:"
              ls -la "$MAIN_DIR"
            fi
            
            # 使用宝塔PM2管理器适配的命令 - 增加更详细的调试
            echo "🔄 重启后端服务..."
            # 检查PM2管理器脚本是否存在
            PM2_SCRIPT="/www/server/panel/pyenv/bin/python3 /www/server/panel/tools/pm2_manager.py"
            if [ -f "/www/server/panel/tools/pm2_manager.py" ]; then
              echo "✅ PM2管理器脚本存在"
              # 先检查服务是否已存在
              if $PM2_SCRIPT list | grep -q "nestAdmin"; then
                echo "✅ 服务 nestAdmin 已存在，尝试重启..."
                $PM2_SCRIPT restart nestAdmin
                RESTART_STATUS=$?
                if [ $RESTART_STATUS -eq 0 ]; then
                  echo "✅ 后端服务重启成功"
                else
                  echo "❌ 后端服务重启失败，错误码: $RESTART_STATUS"
                fi
              else
                echo "⚠️  服务 nestAdmin 不存在，尝试添加..."
                # 确保构建文件存在
                if [ -f "$BACKEND_DIR/dist/main.js" ]; then
                  $PM2_SCRIPT add -n nestAdmin -p "$BACKEND_DIR/dist/main.js"
                  ADD_STATUS=$?
                  if [ $ADD_STATUS -eq 0 ]; then
                    echo "✅ 后端服务添加成功"
                  else
                    echo "❌ 后端服务添加失败，错误码: $ADD_STATUS"
                  fi
                else
                  echo "❌ 主入口文件不存在，无法添加服务"
                fi
              fi
            else
              echo "❌ PM2管理器脚本不存在: $PM2_SCRIPT"
              echo "📁 检查宝塔目录结构:"
              ls -la /www/server/panel/ 2>/dev/null || echo "❌ 无法访问宝塔面板目录"
              # 尝试使用直接的pm2命令
              if command -v pm2 &> /dev/null; then
                echo "✅ pm2 命令可用，尝试直接使用..."
                pm2 list
                if pm2 show nestAdmin > /dev/null 2>&1; then
                  pm2 restart nestAdmin
                else
                  if [ -f "$BACKEND_DIR/dist/main.js" ]; then
                    pm2 start "$BACKEND_DIR/dist/main.js" --name nestAdmin
                  fi
                fi
              else
                echo "❌ pm2 命令不可用"
              fi
            fi
            
            # 更新前端 - 增加详细调试
            echo "🎨 更新前端应用..."
            FRONTEND_DIR="$MAIN_DIR/frontend"
            echo "📁 检查前端目录: $FRONTEND_DIR"
            
            if [ -d "$FRONTEND_DIR" ]; then
              echo "✅ 前端目录存在"
              cd "$FRONTEND_DIR"
              echo "📁 切换到前端目录: $(pwd)"
              echo "📁 前端目录内容:"
              ls -la
              
              echo "🧹 清理旧依赖..."
              rm -rf node_modules 2>/dev/null || echo "⚠️  旧依赖清理失败，可能不存在"
              
              echo "📦 安装前端依赖..."
              npm install --production --legacy-peer-deps --verbose
              NPM_INSTALL_STATUS=$?
              if [ $NPM_INSTALL_STATUS -eq 0 ]; then
                echo "✅ 前端依赖安装成功"
              else
                echo "❌ 前端依赖安装失败，错误码: $NPM_INSTALL_STATUS"
              fi
              
              echo "🏗️  构建前端项目..."
              if [ -f "package.json" ]; then
                echo "✅ 发现package.json，查看构建脚本..."
                grep -A 5 "scripts" package.json
                npm run build
                BUILD_STATUS=$?
                if [ $BUILD_STATUS -eq 0 ]; then
                  echo "✅ 前端构建成功"
                  # 检查构建输出目录
                  if [ -d "dist" ]; then
                    echo "✅ 构建输出目录存在"
                    ls -la dist
                  else
                    echo "❌ 构建输出目录不存在，构建可能失败"
                  fi
                else
                  echo "❌ 前端构建失败，错误码: $BUILD_STATUS"
                fi
              else
                echo "❌ package.json 不存在，无法构建"
              fi
            else
              echo "❌ 前端目录不存在: $FRONTEND_DIR"
            fi
            
            # 配置Nginx - 增加详细调试
            echo "🌐 配置Nginx..."
            # 检查nginx.conf是否存在
            NGINX_CONF_SRC="$FRONTEND_DIR/nginx.conf"
            NGINX_CONF_DEST="/www/server/nginx/conf/vhost/nestadmin.conf"
            
            if [ -f "$NGINX_CONF_SRC" ]; then
              echo "✅ 找到Nginx配置源文件: $NGINX_CONF_SRC"
              # 查看配置文件内容摘要
              echo "📋 配置文件内容摘要:"
              head -n 20 "$NGINX_CONF_SRC"
              
              # 检查目标目录是否存在
              NGINX_DIR="/www/server/nginx/conf/vhost"
              if [ -d "$NGINX_DIR" ]; then
                echo "✅ Nginx配置目录存在: $NGINX_DIR"
                # 创建备份
                echo "📋 创建配置备份..."
                cp "$NGINX_CONF_DEST" "$NGINX_CONF_DEST.bak" 2>/dev/null || echo "⚠️  备份创建失败，可能目标文件不存在"
                
                # 复制配置文件
                echo "📋 复制Nginx配置文件..."
                cp "$NGINX_CONF_SRC" "$NGINX_CONF_DEST"
                CP_STATUS=$?
                if [ $CP_STATUS -eq 0 ]; then
                  echo "✅ Nginx配置文件复制成功"
                else
                  echo "❌ Nginx配置文件复制失败，错误码: $CP_STATUS"
                  echo "🔄 尝试使用sudo复制..."
                  sudo cp "$NGINX_CONF_SRC" "$NGINX_CONF_DEST" 2>/dev/null || echo "❌ sudo复制也失败"
                fi
              else
                echo "❌ Nginx配置目录不存在: $NGINX_DIR"
                echo "📁 检查宝塔Nginx目录:"
                ls -la /www/server/nginx/ 2>/dev/null || echo "❌ 无法访问Nginx目录"
              fi
            else
              echo "❌ Nginx配置源文件不存在: $NGINX_CONF_SRC"
              echo "📁 检查前端目录内容:"
              ls -la "$FRONTEND_DIR"
            fi
            
            # 重新加载Nginx配置 - 增加详细调试
            echo "🔄 重新加载Nginx配置..."
            NGINX_BIN="/www/server/nginx/sbin/nginx"
            if [ -f "$NGINX_BIN" ]; then
              echo "✅ Nginx二进制文件存在: $NGINX_BIN"
              # 测试配置
              echo "🧪 测试Nginx配置..."
              $NGINX_BIN -t
              TEST_STATUS=$?
              if [ $TEST_STATUS -eq 0 ]; then
                echo "✅ Nginx配置测试通过"
                # 重新加载
                echo "🔄 重新加载Nginx..."
                $NGINX_BIN -s reload
                RELOAD_STATUS=$?
                if [ $RELOAD_STATUS -eq 0 ]; then
                  echo "✅ Nginx配置重新加载成功"
                else
                  echo "❌ Nginx重新加载失败，错误码: $RELOAD_STATUS"
                fi
              else
                echo "❌ Nginx配置测试失败，错误码: $TEST_STATUS"
              fi
            else
              echo "❌ Nginx二进制文件不存在: $NGINX_BIN"
              # 尝试使用系统nginx
              if command -v nginx &> /dev/null; then
                echo "✅ 系统nginx命令可用，尝试使用..."
                nginx -t && nginx -s reload
              else
                echo "❌ nginx命令不可用"
              fi
            fi
            
            # 检查健康状态 - 增加详细调试
            echo "🧪 检查服务健康状态..."
            # 检查curl是否可用
            if command -v curl &> /dev/null; then
              echo "✅ curl 命令可用"
              sleep 5
              echo "🔍 尝试连接后端服务..."
              curl -v http://localhost:3001/api/health 2>&1 || echo "⚠️  健康检查请求失败"
              
              # 检查服务是否在运行
              echo "🔍 检查后端端口3001是否被占用..."
              netstat -tuln | grep 3001 || ss -tuln | grep 3001 || echo "⚠️  未发现端口3001被占用"
              
              # 检查PM2服务状态
              echo "🔍 检查PM2服务状态..."
              if command -v pm2 &> /dev/null; then
                pm2 status
              elif [ -f "$PM2_SCRIPT" ]; then
                $PM2_SCRIPT list
              else
                echo "⚠️  无法检查PM2状态"
              fi
            else
              echo "❌ curl 命令不可用，跳过健康检查"
            fi
            
            echo "=== 部署完成，详细日志总结 ==="
            echo "📊 部署摘要："
            echo "- 项目目录: $MAIN_DIR"
            echo "- 后端目录: $BACKEND_DIR"
            echo "- 前端目录: $FRONTEND_DIR"
            echo "- 执行用户: $(whoami)"
            echo "- 执行时间: $(date)"
            echo "- 部署状态: 脚本执行完成（检查日志查看详细成功/失败信息）"
            echo "=============================="
      
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            console.log('❌ 部署失败！');
            // 直接在GitHub Actions日志中输出错误信息，避免SSH连接问题